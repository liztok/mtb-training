<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTB Trening Plan U15 - Training Tracker</title>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2c5aa0;
            --primary-dark: #1a3d6b;
            --primary-light: #4a7dc4;
            --secondary: #e8f0f8;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #212529;
            --c1: #28a745;
            --c2: #20c997;
            --c3: #ffc107;
            --c4: #fd7e14;
            --c5: #dc3545;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* Auth Screens */
        .auth-container {
            max-width: 450px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .auth-container h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }

        .auth-switch a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Main App Styles */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-box .label {
            font-size: 12px;
            opacity: 0.9;
        }

        .user-info {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info .user-name {
            font-weight: 600;
        }

        .user-info button {
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.5);
            padding: 6px 12px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .user-info button:hover {
            background: rgba(255,255,255,0.5);
        }

        nav {
            background: var(--secondary);
            padding: 15px 30px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            border-bottom: 3px solid var(--primary);
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            background: white;
            color: var(--primary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
        }

        .content {
            padding: 30px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Calendar Styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--secondary);
            border-radius: 10px;
        }

        .calendar-header h2 {
            color: var(--primary);
            font-size: 22px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            padding: 8px 15px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .calendar-nav button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: var(--primary);
            color: white;
            border-radius: 5px;
            font-size: 14px;
        }

        .calendar-day {
            min-height: 100px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .calendar-day:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            background: #f5f5f5;
        }

        .calendar-day.today {
            border-color: var(--success);
            border-width: 3px;
            background: #e8f5e9;
        }

        .calendar-day.has-training {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
            border-color: var(--warning);
        }

        .calendar-day.completed {
            background: linear-gradient(135deg, #e8f5e9 0%, #d4edda 100%);
            border-color: var(--success);
        }

        .day-number {
            font-weight: bold;
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .day-training {
            font-size: 11px;
            padding: 4px;
            background: rgba(44, 90, 160, 0.1);
            border-radius: 4px;
            margin: 2px 0;
            color: var(--primary-dark);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .day-training.karate {
            background: rgba(255, 193, 7, 0.2);
        }

        .day-training.bike {
            background: rgba(40, 167, 69, 0.2);
        }

        .day-training.gym {
            background: rgba(220, 53, 69, 0.2);
        }

        .day-training.rest {
            background: rgba(108, 117, 125, 0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: var(--danger);
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary);
        }

        .modal-header h2 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .modal-header .date {
            color: #666;
            font-size: 14px;
        }

        .training-info {
            background: var(--secondary);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .training-info h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #555;
        }

        .info-value {
            color: var(--primary-dark);
        }

        .route-link, .workout-link {
            display: inline-block;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin: 5px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .route-link:hover, .workout-link:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .log-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .log-form h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .log-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        .log-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .log-table tr:hover {
            background: var(--secondary);
        }

        .log-table .delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .intensity-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }

        .intensity-c1 { background: var(--c1); }
        .intensity-c2 { background: var(--c2); }
        .intensity-c3 { background: var(--c3); }
        .intensity-c4 { background: var(--c4); }
        .intensity-c5 { background: var(--c5); }

        .routes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .route-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .route-card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transform: translateY(-4px);
        }

        .route-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 18px;
        }

        .route-details {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .route-detail {
            display: flex;
            flex-direction: column;
        }

        .route-detail .label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
        }

        .route-detail .value {
            font-size: 16px;
            color: var(--primary-dark);
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            transition: width 0.3s;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--primary);
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 18px;
            }

            .header-stats {
                width: 100%;
                justify-content: space-around;
                margin-top: 10px;
            }

            .calendar-grid {
                gap: 5px;
            }

            .calendar-day {
                min-height: 80px;
                padding: 5px;
            }

            .day-number {
                font-size: 14px;
            }

            .day-training {
                font-size: 9px;
                padding: 2px;
            }

            .content {
                padding: 15px;
            }

            .modal-content {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .routes-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen (shown when not logged in) -->
    <div id="authScreen" class="auth-container" style="display: none;">
        <h1>üöµ MTB Training Tracker</h1>

        <!-- Login Form -->
        <div id="loginForm" class="auth-form" style="display: none;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">Prijava</h2>
            <div id="loginError"></div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
                <label>Geslo</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button class="btn btn-primary" onclick="login()">Prijava</button>
            <div class="auth-switch">
                ≈†e nima≈° raƒçuna? <a href="#" onclick="showRegister(); return false;">Registriraj se</a>
            </div>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="auth-form" style="display: none;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">Registracija</h2>
            <div id="registerError"></div>
            <div class="form-group">
                <label>Ime in priimek</label>
                <input type="text" id="registerName" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="registerEmail" required>
            </div>
            <div class="form-group">
                <label>Geslo (min. 6 znakov)</label>
                <input type="password" id="registerPassword" required>
            </div>
            <div class="form-group">
                <label>Kraj bivanja</label>
                <input type="text" id="registerLocation" placeholder="npr. Zavrtec, Rovte">
            </div>
            <div class="form-group">
                <label>Priljubljena aplikacija za kolesarjenje</label>
                <select id="registerCyclingApp">
                    <option value="komoot">Komoot</option>
                    <option value="strava">Strava</option>
                    <option value="ridewithgps">RideWithGPS</option>
                    <option value="garmin">Garmin Connect</option>
                </select>
            </div>
            <div class="form-group">
                <label>Priljubljena aplikacija za indoor trening</label>
                <select id="registerIndoorApp">
                    <option value="mywhoosh">MyWhoosh</option>
                    <option value="zwift">Zwift</option>
                    <option value="trainerroad">TrainerRoad</option>
                    <option value="rouvy">Rouvy</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="register()">Registriraj se</button>
            <div class="auth-switch">
                ≈Ωe ima≈° raƒçun? <a href="#" onclick="showLogin(); return false;">Prijava</a>
            </div>
        </div>
    </div>

    <!-- Main App (shown when logged in) -->
    <div id="mainApp" class="container" style="display: none;">
        <header>
            <h1>üöµ MTB Trening Plan U15</h1>
            <div class="header-stats">
                <div class="stat-box">
                    <div class="value" id="totalTrainings">0</div>
                    <div class="label">Opravljenih treningov</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="totalHours">0h</div>
                    <div class="label">Skupaj ur</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="totalKm">0km</div>
                    <div class="label">Skupaj km</div>
                </div>
            </div>
            <div class="user-info">
                <div>
                    <div class="user-name" id="userName">Uporabnik</div>
                    <div style="font-size: 11px; opacity: 0.8;" id="userLocation">-</div>
                </div>
                <button onclick="logout()">Odjava</button>
            </div>
        </header>

        <nav>
            <button class="nav-btn active" onclick="showView('calendar')">üìÖ Koledar</button>
            <button class="nav-btn" onclick="showView('routes')">üó∫Ô∏è Poti</button>
            <button class="nav-btn" onclick="showView('workouts')">üè† Indoor</button>
            <button class="nav-btn" onclick="showView('log')">üìù Zgodovina</button>
            <button class="nav-btn" onclick="showView('stats')">üìä Statistika</button>
            <button class="nav-btn" onclick="showView('profile')">üë§ Profil</button>
            <button class="nav-btn" onclick="showView('info')">‚ÑπÔ∏è Info</button>
        </nav>

        <div class="content">
            <!-- Calendar View -->
            <div id="calendar" class="view active">
                <div class="calendar-header">
                    <h2 id="currentMonth">November 2025</h2>
                    <div class="calendar-nav">
                        <button onclick="previousMonth()">‚Üê Prej≈°nji</button>
                        <button onclick="today()">Danes</button>
                        <button onclick="nextMonth()">Naslednji ‚Üí</button>
                    </div>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>

            <!-- Routes View -->
            <div id="routes" class="view">
                <h2 style="color: var(--primary); margin-bottom: 20px;">üó∫Ô∏è Kolesarske Poti</h2>
                <div id="routesGrid" class="routes-grid"></div>
            </div>

            <!-- Workouts View -->
            <div id="workouts" class="view">
                <h2 style="color: var(--primary); margin-bottom: 20px;">üè† Indoor Workouts</h2>
                <div id="workoutsGrid" class="routes-grid"></div>
            </div>

            <!-- Log View -->
            <div id="log" class="view">
                <h2 style="color: var(--primary); margin-bottom: 20px;">üìù Zgodovina Treningov</h2>
                <div id="logContent"></div>
            </div>

            <!-- Stats View -->
            <div id="stats" class="view">
                <h2 style="color: var(--primary); margin-bottom: 20px;">üìä Statistika</h2>
                <div id="statsContent"></div>
            </div>

            <!-- Profile View -->
            <div id="profile" class="view">
                <h2 style="color: var(--primary); margin-bottom: 20px;">üë§ Moj Profil</h2>
                <div id="profileContent"></div>
            </div>

            <!-- Info View -->
            <div id="info" class="view">
                <h2 style="color: var(--primary); margin-bottom: 20px;">‚ÑπÔ∏è Informacije</h2>
                <div class="training-info">
                    <h3>üéØ Intenzivnostne Cone</h3>
                    <div class="info-row">
                        <span class="info-label"><span class="intensity-badge intensity-c1">C1</span> Zelo lahko (60-70%)</span>
                        <span class="info-value">124-145 BPM</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><span class="intensity-badge intensity-c2">C2</span> Lahko (70-80%)</span>
                        <span class="info-value">145-166 BPM</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><span class="intensity-badge intensity-c3">C3</span> Zmerno (80-87%)</span>
                        <span class="info-value">166-180 BPM</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><span class="intensity-badge intensity-c4">C4</span> Te≈æko (87-92%)</span>
                        <span class="info-value">180-190 BPM</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label"><span class="intensity-badge intensity-c5">C5</span> Maksimalno (92%+)</span>
                        <span class="info-value">190+ BPM</span>
                    </div>
                </div>

                <div class="training-info" style="margin-top: 20px;">
                    <h3>üìÖ Tedenski Okvir</h3>
                    <p style="margin-bottom: 10px;">Obdobje: 18. november 2025 - 28. februar 2026 (15 tednov)</p>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li><strong>Ponedeljek:</strong> Karate - gibljivost in koordinacija</li>
                        <li><strong>Torek:</strong> Kolo - Te≈æja vo≈ænja 90-120 min (C2-C4)</li>
                        <li><strong>Sreda:</strong> Karate - gibljivost in koordinacija</li>
                        <li><strong>ƒåetrtek:</strong> GYM (vsak 2. teden) / Trainer ali lahka vo≈ænja</li>
                        <li><strong>Petek:</strong> Poƒçitek ali lahka aktivnost</li>
                        <li><strong>Vikend:</strong> Dalj≈°a lahkotna vo≈ænja 2-3.5h (C1-C2)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Training Detail Modal -->
    <div id="trainingModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <div class="modal-header">
                <h2 id="modalTitle">Trening</h2>
                <div class="date" id="modalDate"></div>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // ========================================
        // SUPABASE CONFIGURATION
        // ========================================
        const SUPABASE_URL = 'https://pxmrnpfbuxicgdmlcakh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4bXJucGZidXhpY2dkbWxjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTg4NjQsImV4cCI6MjA3OTAzNDg2NH0.rd2hITsB46zsQGNqWEvzSnFzjSuOfGp2M50C7eXjwEE';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ========================================
        // STATE MANAGEMENT
        // ========================================
        let currentUser = null;
        let userProfile = null;
        let trainingLogs = [];
        let customEvents = []; // Custom training events (add/delete)
        let currentDate = new Date(2025, 10, 18);
        let currentView = 'calendar';

        // ========================================
        // TRAINING PLAN DATA
        // ========================================
        const TRAINING_PLAN = {
            '2025-11-18': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2025-11-19': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: 'Rovte-Logatec Loop', duration: '90-120 min', intensity: 'C2-C4', route: 1, intervals: '4x (2 min C4 + 3 min C2)' },
            '2025-11-20': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2025-11-21': { type: 'gym', name: 'GYM - Ekipni', description: 'ƒårni Vrh telovadnica', duration: '105 min', intensity: null },
            '2025-11-22': { type: 'rest', name: 'Poƒçitek', description: 'Raztezanje', duration: '30-45 min', intensity: 'C1' },
            '2025-11-23': { type: 'bike', name: 'KOLO - Dalj≈°a tura', description: 'Izberi: ≈†marna Gora / Polhov Gradec', duration: '2-2.5h', intensity: 'C1-C2', route: 5 },
            '2025-11-24': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Dru≈æinski sprehod', duration: '60-90 min', intensity: 'C1' },
            '2025-11-25': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2025-11-26': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: '≈Ωibr≈°e-Hotedr≈°ica Circuit', duration: '90-120 min', intensity: 'C2-C4', route: 2, intervals: '5x (3 min C4 + 3 min C2)' },
            '2025-11-27': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2025-11-28': { type: 'trainer', name: 'TRAINER - Indoor', description: 'Threshold Builder', duration: '50-60 min', intensity: 'C2-C3', workout: 6 },
            '2025-11-29': { type: 'rest', name: 'Lahka aktivnost', description: 'Raztezanje + lahek tek/hoja', duration: '30-40 min', intensity: 'C1' },
            '2025-11-30': { type: 'bike', name: 'KOLO - Dalj≈°a tura', description: 'Idrija Loop', duration: '2-2.5h', intensity: 'C2', route: 7 },
            '2025-12-01': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Pohod z dru≈æino', duration: '60-90 min', intensity: 'C1' },

            // Week 3 (Dec 2-8)
            '2025-12-02': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2025-12-03': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: 'Rovte MTB Trails', duration: '90-120 min', intensity: 'C2-C4', route: 3, intervals: '6x (2 min C4 + 2 min C2)' },
            '2025-12-04': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2025-12-05': { type: 'trainer', name: 'TRAINER - Indoor', description: 'Sweet Spot Training', duration: '45-60 min', intensity: 'C3', workout: 7 },
            '2025-12-06': { type: 'rest', name: 'Poƒçitek', description: 'Raztezanje', duration: '30-45 min', intensity: 'C1' },
            '2025-12-07': { type: 'bike', name: 'KOLO - Dalj≈°a tura', description: 'Postojnska Vrata', duration: '2-2.5h', intensity: 'C1-C2', route: 8 },
            '2025-12-08': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Lahka aktivnost', duration: '60-90 min', intensity: 'C1' },

            // Week 4 (Dec 9-15)
            '2025-12-09': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2025-12-10': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: 'Zavrtec Intervali', duration: '90-120 min', intensity: 'C2-C4', route: 4, intervals: '5x (3 min C4 + 3 min C2)' },
            '2025-12-11': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2025-12-12': { type: 'gym', name: 'GYM - Ekipni', description: 'ƒårni Vrh telovadnica', duration: '105 min', intensity: null },
            '2025-12-13': { type: 'rest', name: 'Lahka aktivnost', description: 'Raztezanje + lahek tek', duration: '30-40 min', intensity: 'C1' },
            '2025-12-14': { type: 'bike', name: 'KOLO - Dalj≈°a tura', description: 'Bevke-Borovnica-Vrhnika', duration: '2-3h', intensity: 'C1-C2', route: 10 },
            '2025-12-15': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Dru≈æinski sprehod', duration: '60-90 min', intensity: 'C1' },

            // Week 5 (Dec 16-22)
            '2025-12-16': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2025-12-17': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: 'Rovte-Logatec Loop', duration: '90-120 min', intensity: 'C2-C4', route: 1, intervals: '4x (3 min C4 + 3 min C2)' },
            '2025-12-18': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2025-12-19': { type: 'trainer', name: 'TRAINER - Indoor', description: 'Tempo Intervals', duration: '45-60 min', intensity: 'C3', workout: 8 },
            '2025-12-20': { type: 'rest', name: 'Poƒçitek', description: 'Raztezanje', duration: '30-45 min', intensity: 'C1' },
            '2025-12-21': { type: 'bike', name: 'KOLO - Dalj≈°a tura', description: 'Polhograjski Dolomiti', duration: '2.5-3h', intensity: 'C1-C2', route: 6 },
            '2025-12-22': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Dru≈æinska aktivnost', duration: '60-90 min', intensity: 'C1' },

            // Week 6 (Dec 23-29) - Prazniki
            '2025-12-23': { type: 'rest', name: 'Prazniki - Poƒçitek', description: 'Raztezanje', duration: '30-45 min', intensity: 'C1' },
            '2025-12-24': { type: 'rest', name: 'Bo≈æiƒç - Aktivni poƒçitek', description: 'Lahek sprehod', duration: '60 min', intensity: 'C1' },
            '2025-12-25': { type: 'rest', name: 'Bo≈æiƒç - Poƒçitek', description: 'Dru≈æina', duration: '-', intensity: null },
            '2025-12-26': { type: 'bike', name: 'KOLO - Lahka vo≈ænja', description: 'Kratek sprostilen izhod', duration: '60-90 min', intensity: 'C1', route: 3 },
            '2025-12-27': { type: 'rest', name: 'Poƒçitek', description: 'Raztezanje', duration: '30-45 min', intensity: 'C1' },
            '2025-12-28': { type: 'bike', name: 'KOLO - Lahka tura', description: 'Zavrtec okolica', duration: '90-120 min', intensity: 'C1-C2', route: 4 },
            '2025-12-29': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Sprehod', duration: '60 min', intensity: 'C1' },

            // Week 7 (Dec 30 - Jan 5)
            '2025-12-30': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2025-12-31': { type: 'bike', name: 'KOLO - Konec leta', description: 'Lahka tura', duration: '60-90 min', intensity: 'C1-C2', route: 3 },
            '2026-01-01': { type: 'rest', name: 'Novo leto - Poƒçitek', description: 'Dru≈æina', duration: '-', intensity: null },
            '2026-01-02': { type: 'rest', name: 'Novo leto - Aktivni poƒçitek', description: 'Sprehod', duration: '60 min', intensity: 'C1' },
            '2026-01-03': { type: 'rest', name: 'Poƒçitek', description: 'Raztezanje', duration: '30-45 min', intensity: 'C1' },
            '2026-01-04': { type: 'bike', name: 'KOLO - Povratek k treningu', description: 'Rovte MTB', duration: '90-120 min', intensity: 'C2', route: 3 },
            '2026-01-05': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Lahka aktivnost', duration: '60 min', intensity: 'C1' },

            // Week 8 (Jan 6-12) - Nazaj k rednem treningu
            '2026-01-06': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-01-07': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: '≈Ωibr≈°e-Hotedr≈°ica', duration: '90-120 min', intensity: 'C2-C4', route: 2, intervals: '5x (3 min C4 + 3 min C2)' },
            '2026-01-08': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-01-09': { type: 'gym', name: 'GYM - Ekipni', description: 'ƒårni Vrh telovadnica', duration: '105 min', intensity: null },
            '2026-01-10': { type: 'rest', name: 'Poƒçitek', description: 'Raztezanje', duration: '30-45 min', intensity: 'C1' },
            '2026-01-11': { type: 'bike', name: 'KOLO - Dalj≈°a tura', description: 'Idrija Loop', duration: '2.5-3h', intensity: 'C1-C2', route: 7 },
            '2026-01-12': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Dru≈æinski sprehod', duration: '60-90 min', intensity: 'C1' },

            // Week 9 (Jan 13-19)
            '2026-01-13': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-01-14': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: 'Rovte-Logatec', duration: '90-120 min', intensity: 'C2-C4', route: 1, intervals: '6x (3 min C4 + 2 min C2)' },
            '2026-01-15': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-01-16': { type: 'trainer', name: 'TRAINER - Indoor', description: 'Pyramid Workout', duration: '50-60 min', intensity: 'C3-C4', workout: 9 },
            '2026-01-17': { type: 'rest', name: 'Lahka aktivnost', description: 'Raztezanje + tek', duration: '30-40 min', intensity: 'C1' },
            '2026-01-18': { type: 'bike', name: 'KOLO - Dalj≈°a tura', description: '≈†marna Gora', duration: '2.5-3h', intensity: 'C1-C2', route: 5 },
            '2026-01-19': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Lahka aktivnost', duration: '60-90 min', intensity: 'C1' },

            // Week 10 (Jan 20-26)
            '2026-01-20': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-01-21': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: 'Zavrtec Intervali', duration: '90-120 min', intensity: 'C2-C4', route: 4, intervals: '5x (4 min C4 + 3 min C2)' },
            '2026-01-22': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-01-23': { type: 'gym', name: 'GYM - Ekipni', description: 'ƒårni Vrh telovadnica', duration: '105 min', intensity: null },
            '2026-01-24': { type: 'rest', name: 'Poƒçitek', description: 'Raztezanje', duration: '30-45 min', intensity: 'C1' },
            '2026-01-25': { type: 'bike', name: 'KOLO - Dalj≈°a tura', description: 'Ljubljansko Barje', duration: '3-3.5h', intensity: 'C1-C2', route: 9 },
            '2026-01-26': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Dru≈æinski sprehod', duration: '60-90 min', intensity: 'C1' },

            // Week 11 (Jan 27 - Feb 2)
            '2026-01-27': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-01-28': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: 'Rovte MTB Trails', duration: '90-120 min', intensity: 'C2-C4', route: 3, intervals: '6x (3 min C4 + 2 min C2)' },
            '2026-01-29': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-01-30': { type: 'trainer', name: 'TRAINER - Indoor', description: 'Threshold Builder', duration: '50-60 min', intensity: 'C2-C3', workout: 6 },
            '2026-01-31': { type: 'rest', name: 'Lahka aktivnost', description: 'Raztezanje + lahek tek', duration: '30-40 min', intensity: 'C1' },
            '2026-02-01': { type: 'bike', name: 'KOLO - Dalj≈°a tura', description: 'Polhograjski Dolomiti', duration: '2.5-3h', intensity: 'C1-C2', route: 6 },
            '2026-02-02': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Lahka aktivnost', duration: '60-90 min', intensity: 'C1' },

            // Week 12 (Feb 3-9)
            '2026-02-03': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-02-04': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: '≈Ωibr≈°e-Hotedr≈°ica', duration: '90-120 min', intensity: 'C2-C4', route: 2, intervals: '5x (4 min C4 + 3 min C2)' },
            '2026-02-05': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-02-06': { type: 'gym', name: 'GYM - Ekipni', description: 'ƒårni Vrh telovadnica', duration: '105 min', intensity: null },
            '2026-02-07': { type: 'rest', name: 'Poƒçitek', description: 'Raztezanje', duration: '30-45 min', intensity: 'C1' },
            '2026-02-08': { type: 'bike', name: 'KOLO - Pre≈°ernov dan tura', description: 'Idrija Loop', duration: '2.5-3h', intensity: 'C1-C2', route: 7 },
            '2026-02-09': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Dru≈æinski sprehod', duration: '60-90 min', intensity: 'C1' },

            // Week 13 (Feb 10-16)
            '2026-02-10': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-02-11': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: 'Rovte-Logatec', duration: '90-120 min', intensity: 'C2-C4', route: 1, intervals: '6x (4 min C4 + 2 min C2)' },
            '2026-02-12': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-02-13': { type: 'trainer', name: 'TRAINER - Indoor', description: 'Sweet Spot', duration: '45-60 min', intensity: 'C3', workout: 7 },
            '2026-02-14': { type: 'rest', name: 'Valentinovo - Poƒçitek', description: 'Raztezanje', duration: '30-45 min', intensity: 'C1' },
            '2026-02-15': { type: 'bike', name: 'KOLO - Dalj≈°a tura', description: 'Postojnska Vrata', duration: '2-2.5h', intensity: 'C1-C2', route: 8 },
            '2026-02-16': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Lahka aktivnost', duration: '60-90 min', intensity: 'C1' },

            // Week 14 (Feb 17-23)
            '2026-02-17': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-02-18': { type: 'bike', name: 'KOLO - Te≈æja vo≈ænja', description: 'Zavrtec Intervali', duration: '90-120 min', intensity: 'C2-C4', route: 4, intervals: '6x (4 min C4 + 3 min C2)' },
            '2026-02-19': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-02-20': { type: 'gym', name: 'GYM - Ekipni', description: 'ƒårni Vrh telovadnica', duration: '105 min', intensity: null },
            '2026-02-21': { type: 'rest', name: 'Lahka aktivnost', description: 'Raztezanje + lahek tek', duration: '30-40 min', intensity: 'C1' },
            '2026-02-22': { type: 'bike', name: 'KOLO - Dalj≈°a tura', description: 'Bevke-Borovnica-Vrhnika', duration: '2.5-3h', intensity: 'C1-C2', route: 10 },
            '2026-02-23': { type: 'rest', name: 'Aktivni poƒçitek', description: 'Dru≈æinski sprehod', duration: '60-90 min', intensity: 'C1' },

            // Week 15 - Final week (Feb 24-28)
            '2026-02-24': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-02-25': { type: 'bike', name: 'KOLO - Zakljuƒçna vo≈ænja', description: 'Rovte-Logatec FTP Test', duration: '90-120 min', intensity: 'C2-C4', route: 1, intervals: 'FTP test 20 min' },
            '2026-02-26': { type: 'karate', name: 'Karate', description: 'Gibljivost, koordinacija', duration: '60-90 min', intensity: null },
            '2026-02-27': { type: 'trainer', name: 'TRAINER - Recovery', description: 'Regeneracija', duration: '45 min', intensity: 'C1-C2', workout: 1 },
            '2026-02-28': { type: 'rest', name: 'Zakljuƒçek mezocikla - Poƒçitek', description: 'Popoln poƒçitek pred novim ciklom', duration: '-', intensity: null }
        };

        // Routes data with multiple app support
        const ROUTES_DATA = {
            1: {
                name: 'Rovte - Logatec Loop',
                distance: '25-30 km',
                elevation: '400-500 m',
                intensity: 'C2-C3, intervali C4',
                type: 'Asfalt/makadam mix',
                waypoints: [
                    [45.9368, 14.1245],  // Rovte start
                    [45.9280, 14.0980],  // Towards Logatec
                    [45.9156, 14.0783],  // Logatec area
                    [45.9100, 14.1100],  // Return route
                    [45.9368, 14.1245]   // Back to Rovte
                ],
                description: 'Glavni testni krog za merjenje napredka'
            },
            2: {
                name: '≈Ωibr≈°e - Hotedr≈°ica Circuit',
                distance: '22-28 km',
                elevation: '450-550 m',
                intensity: 'C2-C3',
                type: 'Mix asfalt/gozdne ceste',
                waypoints: [
                    [45.9368, 14.1245],  // Rovte/Zavrtec start
                    [45.9500, 14.1400],  // ≈Ωibr≈°e area
                    [45.9600, 14.1200],  // Hotedr≈°ica
                    [45.9450, 14.1100],  // Loop back
                    [45.9368, 14.1245]   // Return
                ],
                description: 'Tehniƒçno zahtevna pot z vzponi'
            },
            3: {
                name: 'Rovte MTB Trails',
                distance: '15-20 km',
                elevation: '300-400 m',
                intensity: 'C2-C3 + tehnika',
                type: 'Single track, gozdne ceste',
                waypoints: [
                    [45.9368, 14.1245],  // Start
                    [45.9300, 14.1350],  // Trail section
                    [45.9400, 14.1450],  // Loop
                    [45.9368, 14.1245]   // Return
                ],
                description: 'Fokus na tehniƒçne ve≈°ƒçine'
            },
            4: {
                name: 'Zavrtec - Intervalni krog',
                distance: '18-22 km',
                elevation: '350-450 m',
                intensity: 'C2 + intervali C4-C5',
                type: 'Mix terrain',
                waypoints: [
                    [45.9368, 14.1245],  // Zavrtec start
                    [45.9250, 14.1350],  // Climb section
                    [45.9200, 14.1200],  // Interval section
                    [45.9368, 14.1245]   // Return
                ],
                description: 'Strukturirani intervali za moƒç'
            },
            5: {
                name: '≈†marna Gora Loop',
                distance: '25-35 km',
                elevation: '400-600 m',
                intensity: 'C1-C2',
                type: 'Gozdne ceste, makadam',
                waypoints: [
                    [46.0833, 14.4664],  // ≈†marna Gora base
                    [46.0900, 14.4550],  // Ascent
                    [46.0950, 14.4700],  // Loop around
                    [46.0800, 14.4800],  // Return path
                    [46.0833, 14.4664]   // Back to start
                ],
                description: 'Priljubljena vikend tura (Ljubljana 40-50 km)'
            },
            6: {
                name: 'Polhograjski Dolomiti',
                distance: '30-40 km',
                elevation: '500-700 m',
                intensity: 'C2',
                type: 'Gozdne ceste',
                waypoints: [
                    [46.0600, 14.3000],  // Polhov Gradec
                    [46.0700, 14.2800],  // Trail through hills
                    [46.0800, 14.3100],  // Scenic loop
                    [46.0650, 14.3200],  // Return
                    [46.0600, 14.3000]   // Back
                ],
                description: 'Lahka tura v ƒçudoviti okolici'
            },
            7: {
                name: 'Idrija - Spodnja Idrija Loop',
                distance: '28-35 km',
                elevation: '450-550 m',
                intensity: 'C1-C2',
                type: 'Mix asfalt/makadam',
                waypoints: [
                    [46.0000, 13.9833],  // Idrija center
                    [45.9850, 13.9700],  // Spodnja Idrija
                    [45.9900, 14.0000],  // Loop
                    [46.0000, 13.9833]   // Return
                ],
                description: 'Raziskovanje Idrije'
            },
            8: {
                name: 'Postojnska Vrata',
                distance: '20-30 km',
                elevation: '300-400 m',
                intensity: 'C1-C2',
                type: 'Gozdne ceste, ≈°iroki single tracki',
                waypoints: [
                    [45.7764, 14.2139],  // Postojna area
                    [45.7850, 14.2000],  // Trail section
                    [45.7700, 14.2250],  // Loop
                    [45.7764, 14.2139]   // Return
                ],
                description: 'Dru≈æinska tura'
            },
            9: {
                name: 'Ljubljansko Barje Loop',
                distance: '35-45 km',
                elevation: '100-200 m',
                intensity: 'C1-C2',
                type: 'Makadam, asfalt (ravnina)',
                waypoints: [
                    [45.9500, 14.4500],  // Barje start
                    [45.9300, 14.4300],  // South
                    [45.9200, 14.4600],  // East loop
                    [45.9400, 14.4700],  // North
                    [45.9500, 14.4500]   // Return
                ],
                description: 'Dolga lahka tura za vzdr≈æljivost'
            },
            10: {
                name: 'Bevke - Borovnica - Vrhnika',
                distance: '25-32 km',
                elevation: '250-350 m',
                intensity: 'C2',
                type: 'Asfalt in gozdne ceste',
                waypoints: [
                    [45.9700, 14.3000],  // Bevke
                    [45.9550, 14.3150],  // Borovnica
                    [45.9650, 14.2950],  // Vrhnika
                    [45.9700, 14.3000]   // Return
                ],
                description: 'Lokalna tura blizu doma'
            }
        };

        // Workouts data with multiple app support
        const WORKOUTS_DATA = {
            1: {
                name: 'Flat Route - Recovery Ride',
                duration: '45 min',
                intensity: 'C1-C2',
                power: '120-140W',
                description: 'Ravninska pot za regeneracijo',
                workoutId: 'recovery-ride'
            },
            2: {
                name: 'Dubai Arena Loop',
                duration: '50 min',
                intensity: 'C1-C2',
                power: '130-150W',
                description: 'Lahka tura z minimalnimi vzponi',
                workoutId: 'dubai-arena'
            },
            3: {
                name: 'Desert Loop',
                duration: '60 min',
                intensity: 'C2-C3',
                power: '140-170W',
                description: 'Gradnja vzdr≈æljivosti',
                workoutId: 'desert-loop'
            },
            4: {
                name: 'France Route - Gentle Hills',
                duration: '55 min',
                intensity: 'C2-C3',
                power: '145-175W',
                description: 'Blagi vzponi, razvijanje moƒçi',
                workoutId: 'france-gentle'
            },
            5: {
                name: 'Yorkshire Loop',
                duration: '75 min',
                intensity: 'C2',
                power: '135-160W',
                description: 'Dalj≈°a vzdr≈æljivostna vo≈ænja',
                workoutId: 'yorkshire-loop'
            },
            6: {
                name: 'Threshold Builder',
                duration: '50 min',
                intensity: 'C2-C3 intervali',
                power: '150-190W',
                description: '4x (5 min C3 + 3 min C2)',
                workoutId: 'threshold-builder'
            },
            7: {
                name: 'Sweet Spot Training',
                duration: '45 min',
                intensity: 'C3 intervali',
                power: '155-185W',
                description: '3x (8 min C3 + 4 min C2)',
                workoutId: 'sweet-spot'
            },
            8: {
                name: 'Tempo Intervals 45',
                duration: '45 min',
                intensity: 'C3 tempo',
                power: '150-180W',
                description: '6x (4 min C3 + 2 min C1)',
                workoutId: 'tempo-intervals'
            },
            9: {
                name: 'Pyramid Workout',
                duration: '50 min',
                intensity: 'C3-C4 intervali',
                power: '160-200W',
                description: '2-4-6-4-2 min intervali',
                workoutId: 'pyramid'
            },
            10: {
                name: 'Makuri Islands Tour',
                duration: '90 min',
                intensity: 'C1-C2',
                power: '130-155W',
                description: 'Zelo dolga lahkotna vo≈ænja',
                workoutId: 'makuri-islands'
            }
        };

        // ========================================
        // LINK GENERATORS
        // ========================================
        function getRouteLink(routeId, appType = 'komoot') {
            const route = ROUTES_DATA[routeId];
            if (!route) return '#';

            const waypoints = route.waypoints || [];

            // If route has a custom Komoot URL (user-created), use it
            if (route.komootUrl && appType === 'komoot') {
                return {
                    app: route.komootUrl,
                    web: route.komootUrl
                };
            }

            // Build Google Maps directions URL with waypoints (most reliable)
            if (waypoints.length > 0) {
                // Google Maps format: /dir/lat1,lon1/lat2,lon2/lat3,lon3/
                const waypointPath = waypoints.map(wp => `${wp[0]},${wp[1]}`).join('/');
                const googleMapsUrl = `https://www.google.com/maps/dir/${waypointPath}`;

                switch(appType) {
                    case 'komoot':
                        // Open Google Maps with the route - user can view it and recreate in Komoot
                        // Or open Komoot planner centered on start point
                        const centerLat = waypoints[0][0];
                        const centerLon = waypoints[0][1];
                        return {
                            app: googleMapsUrl,
                            web: `https://www.komoot.com/plan/@${centerLat},${centerLon},14z?sport=mtbbike`
                        };

                    case 'strava':
                        return {
                            app: googleMapsUrl,
                            web: googleMapsUrl
                        };

                    case 'ridewithgps':
                        return {
                            app: googleMapsUrl,
                            web: googleMapsUrl
                        };

                    case 'garmin':
                        return {
                            app: googleMapsUrl,
                            web: googleMapsUrl
                        };

                    default:
                        return {
                            app: googleMapsUrl,
                            web: googleMapsUrl
                        };
                }
            }

            return { app: '#', web: '#' };
        }

        function getWorkoutLink(workoutId, appType = 'mywhoosh') {
            const workout = WORKOUTS_DATA[workoutId];
            if (!workout) return '#';

            const id = workout.workoutId;

            switch(appType) {
                case 'mywhoosh':
                    return {
                        app: `mywhoosh://workout/${id}`,
                        web: `https://www.mywhoosh.com/workouts/${id}`
                    };
                case 'zwift':
                    return {
                        app: `zwift://workout/${id}`,
                        web: `https://www.zwift.com/workouts`
                    };
                case 'trainerroad':
                    return {
                        app: `trainerroad://workout/${id}`,
                        web: `https://www.trainerroad.com/app/workouts`
                    };
                case 'rouvy':
                    return {
                        app: `rouvy://workout/${id}`,
                        web: `https://rouvy.com/workouts`
                    };
                default:
                    return {
                        app: '#',
                        web: '#'
                    };
            }
        }

        // ========================================
        // GPX FILE GENERATION
        // ========================================
        function generateGPX(routeId) {
            const route = ROUTES_DATA[routeId];
            if (!route || !route.waypoints) return null;

            const waypoints = route.waypoints;
            const name = route.name;
            const description = route.description;

            // GPX XML structure
            const gpxHeader = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="MTB Training Tracker" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <name>${name}</name>
    <desc>${description}</desc>
    <author>
      <name>MTB Training Tracker</name>
    </author>
  </metadata>
  <trk>
    <name>${name}</name>
    <desc>${description}</desc>
    <type>Cycling</type>
    <trkseg>`;

            const gpxFooter = `
    </trkseg>
  </trk>
</gpx>`;

            // Generate trackpoints
            let trackpoints = '';
            waypoints.forEach((wp, index) => {
                trackpoints += `
      <trkpt lat="${wp[0]}" lon="${wp[1]}">
        <name>Waypoint ${index + 1}</name>
      </trkpt>`;
            });

            return gpxHeader + trackpoints + gpxFooter;
        }

        function downloadGPX(routeId) {
            const gpxContent = generateGPX(routeId);
            if (!gpxContent) {
                alert('Napaka pri generiranju GPX datoteke');
                return;
            }

            const route = ROUTES_DATA[routeId];
            const filename = `${route.name.replace(/\s+/g, '_')}.gpx`;

            // Create blob and download
            const blob = new Blob([gpxContent], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function quickKomootImport(routeId) {
            const route = ROUTES_DATA[routeId];
            const gpxContent = generateGPX(routeId);

            // Create enhanced modal with preview
            const modal = document.getElementById('trainingModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalDate = document.getElementById('modalDate');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = 'üöÄ Komoot Import';
            modalDate.textContent = route.name;

            let html = `
                <div class="training-info">
                    <h3>üìã Avtomatski Import v Komoot</h3>
                    <p><strong>Pot:</strong> ${route.name}</p>
                    <p><strong>Razdalja:</strong> ${route.distance} | <strong>Vi≈°ina:</strong> ${route.elevation}</p>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #2e7d32; margin-bottom: 10px;">‚ú® 3 naƒçini za import:</h4>

                        <div style="margin: 10px 0;">
                            <strong>1Ô∏è‚É£ Najhitrej≈°i (priporoƒçeno):</strong>
                            <button onclick="downloadGPXAndOpenKomoot(${routeId})" class="btn btn-primary" style="margin: 5px 0; width: 100%;">
                                üì• Prenesi GPX + Odpri Komoot
                            </button>
                            <small style="color: #666;">‚Ü≥ Prenese GPX in odpre Komoot import stran</small>
                        </div>

                        <div style="margin: 10px 0;">
                            <strong>2Ô∏è‚É£ Google Maps preview:</strong>
                            <a href="${getRouteLink(routeId, 'komoot').app}" target="_blank" class="btn btn-secondary" style="margin: 5px 0; width: 100%; text-decoration: none; display: block; text-align: center;">
                                üó∫Ô∏è Poglej pot v Google Maps
                            </a>
                            <small style="color: #666;">‚Ü≥ Preveri pot pred importom</small>
                        </div>

                        <div style="margin: 10px 0;">
                            <strong>3Ô∏è‚É£ Neposredni GPX:</strong>
                            <button onclick="copyGPXToClipboard(${routeId})" class="btn btn-success" style="margin: 5px 0; width: 100%;">
                                üìã Kopiraj GPX v clipboard
                            </button>
                            <small style="color: #666;">‚Ü≥ Za roƒçni import ali drugo aplikacijo</small>
                        </div>
                    </div>

                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #e65100; margin-bottom: 10px;">üìñ Koraki za Komoot:</h4>
                        <ol style="margin-left: 20px; line-height: 1.8;">
                            <li>Klikni "üì• Prenesi GPX + Odpri Komoot"</li>
                            <li>Komoot se bo odprl v novem zavihku</li>
                            <li>V Komoot klikni <strong>"Import a Tour"</strong> ali <strong>"Upload GPX"</strong></li>
                            <li>Izberi preneseno datoteko <code>${route.name.replace(/\s+/g, '_')}.gpx</code></li>
                            <li>Komoot bo avtomatsko ustvaril pot z ${route.waypoints?.length || 0} toƒçkami</li>
                            <li>Preveri in shrani pot! üéâ</li>
                        </ol>
                    </div>

                    <div style="background: #f5f5f5; padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <small style="color: #666;">
                            <strong>üí° Namig:</strong> GPX datoteka vsebuje ${route.waypoints?.length || 0} waypoint toƒçk.
                            Komoot bo avtomatsko optimiziral pot med toƒçkami za MTB.
                            Lahko jo ≈°e prilagodi≈° (spremeni≈° povr≈°ino, doda≈° toƒçke...).
                        </small>
                    </div>
                </div>
            `;

            modalBody.innerHTML = html;
            modal.classList.add('active');
        }

        function downloadGPXAndOpenKomoot(routeId) {
            const route = ROUTES_DATA[routeId];

            // Try to open directly in Komoot app/web with coordinates
            const waypoints = route.waypoints;
            if (waypoints && waypoints.length > 0) {
                // Build Komoot coordinate URL
                const coordString = waypoints.map(wp => `${wp[0]},${wp[1]}`).join(',');

                // For mobile devices - try app deep link first
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

                if (isMobile) {
                    // Try Komoot app deep link with coordinates
                    const komootAppUrl = `komoot-preview:tour?coordinates=${coordString}&sport=mtb_easy&name=${encodeURIComponent(route.name)}`;

                    // Attempt to open app
                    window.location.href = komootAppUrl;

                    // Fallback to web after short delay if app doesn't open
                    setTimeout(() => {
                        const webUrl = `https://www.komoot.com/plan/@${waypoints[0][0]},${waypoints[0][1]},14z?sport=mtbbike&name=${encodeURIComponent(route.name)}`;
                        window.open(webUrl, '_blank');
                    }, 1500);
                } else {
                    // For desktop - create an intermediate page that auto-imports
                    createKomootAutoImportPage(routeId);
                }
            }
        }

        function createKomootAutoImportPage(routeId) {
            const route = ROUTES_DATA[routeId];
            const gpxContent = generateGPX(routeId);
            const waypoints = route.waypoints;

            // Build HTML safely without nested template literals
            const htmlParts = [];
            htmlParts.push('<!DOCTYPE html><html><head><meta charset="UTF-8">');
            htmlParts.push('<title>Importing to Komoot</title>');
            htmlParts.push('<style>body{font-family:Arial,sans-serif;max-width:600px;margin:50px auto;padding:20px;text-align:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white}');
            htmlParts.push('.card{background:white;color:#333;padding:30px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.3)}');
            htmlParts.push('.btn{display:inline-block;padding:15px 30px;margin:10px;border-radius:8px;text-decoration:none;font-weight:bold;cursor:pointer;border:none;font-size:16px}');
            htmlParts.push('.btn-primary{background:#ff6900;color:white}.btn-secondary{background:#6c757d;color:white}</style></head><body>');
            htmlParts.push('<div class="card"><h1>üöÄ ' + route.name.replace(/[<>"']/g, '') + '</h1>');
            htmlParts.push('<p><strong>Razdalja:</strong> ' + route.distance + ' | <strong>Vi≈°ina:</strong> ' + route.elevation + '</p>');
            htmlParts.push('<h3>Import v Komoot</h3>');
            htmlParts.push('<button class="btn btn-primary" onclick="downloadAndOpen()">üì• Prenesi GPX + Odpri Komoot</button>');
            htmlParts.push('<button class="btn btn-secondary" onclick="copyGPX()">üìã Kopiraj GPX</button>');
            htmlParts.push('<p style="margin-top:20px"><small>GPX vsebuje ' + waypoints.length + ' waypoint toƒçk</small></p></div>');
            htmlParts.push('<script>const gpxData=' + JSON.stringify(gpxContent) + ';');
            htmlParts.push('const routeName=' + JSON.stringify(route.name.replace(/\s+/g, '_')) + ';');
            htmlParts.push('function downloadAndOpen(){const blob=new Blob([gpxData],{type:"application/gpx+xml"});');
            htmlParts.push('const url=URL.createObjectURL(blob);const a=document.createElement("a");');
            htmlParts.push('a.href=url;a.download=routeName+".gpx";document.body.appendChild(a);a.click();');
            htmlParts.push('document.body.removeChild(a);URL.revokeObjectURL(url);');
            htmlParts.push('setTimeout(function(){window.open("https://www.komoot.com/plan","_blank");');
            htmlParts.push('alert("‚úÖ GPX prenesan!\\n‚úÖ Komoot odprt!\\n\\nV Komoot:\\n‚Üí Klikni Import Tour\\n‚Üí Izberi "+routeName+".gpx");},500);}');
            htmlParts.push('function copyGPX(){navigator.clipboard.writeText(gpxData).then(function(){alert("‚úÖ GPX kopiran!");});}');
            htmlParts.push('window.onload=function(){setTimeout(downloadAndOpen,1000);};</script></body></html>');

            const htmlContent = htmlParts.join('');

            // Open in new window
            const newWindow = window.open('', '_blank');
            if (newWindow) {
                newWindow.document.write(htmlContent);
                newWindow.document.close();
            } else {
                alert('Popup blocked! Please allow popups.');
            }
        }

        function copyGPXToClipboard(routeId) {
            const gpxContent = generateGPX(routeId);
            const route = ROUTES_DATA[routeId];

            navigator.clipboard.writeText(gpxContent).then(() => {
                alert(`‚úÖ GPX za "${route.name}" kopiran v clipboard!\n\n` +
                      `Lahko ga prilepi≈° v:\n` +
                      `‚Ä¢ Komoot (Import ‚Üí Paste GPX)\n` +
                      `‚Ä¢ Garmin Connect\n` +
                      `‚Ä¢ Strava\n` +
                      `‚Ä¢ Katerokoli drugo aplikacijo`);
            }).catch(err => {
                alert('Napaka pri kopiranju. Uporabi "Prenesi GPX" gumb.');
            });
        }

        // ========================================
        // AUTHENTICATION FUNCTIONS
        // ========================================
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                currentUser = session.user;
                await loadUserProfile();
                await loadTrainingLogs();
                await loadCustomEvents();
                showMainApp();
            } else {
                showAuthScreen();
            }
        }

        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            showLogin();
        }

        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            renderCalendar();
            renderRoutes();
            renderWorkouts();
            updateStats();
            updateUserInfo();
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                currentUser = data.user;
                await loadUserProfile();
                await loadTrainingLogs();
                showMainApp();
            } catch (error) {
                errorDiv.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
            }
        }

        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const fullName = document.getElementById('registerName').value;
            const location = document.getElementById('registerLocation').value;
            const cyclingApp = document.getElementById('registerCyclingApp').value;
            const indoorApp = document.getElementById('registerIndoorApp').value;
            const errorDiv = document.getElementById('registerError');

            if (password.length < 6) {
                errorDiv.innerHTML = '<div class="alert alert-error">Geslo mora biti dolgo vsaj 6 znakov</div>';
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: fullName
                        }
                    }
                });

                if (error) throw error;

                // Create profile
                const { error: profileError } = await supabase
                    .from('profiles')
                    .update({
                        full_name: fullName,
                        location: location,
                        cycling_app: cyclingApp,
                        indoor_app: indoorApp
                    })
                    .eq('id', data.user.id);

                if (profileError) throw profileError;

                errorDiv.innerHTML = '<div class="alert alert-success">Registracija uspe≈°na! Preveri email za potrditev.</div>';

                setTimeout(() => {
                    showLogin();
                }, 2000);
            } catch (error) {
                errorDiv.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            userProfile = null;
            trainingLogs = [];
            showAuthScreen();
        }

        // ========================================
        // DATA LOADING FUNCTIONS
        // ========================================
        async function loadUserProfile() {
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (!error && data) {
                userProfile = data;
            }
        }

        async function loadTrainingLogs() {
            const { data, error} = await supabase
                .from('training_logs')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('date', { ascending: false });

            if (!error && data) {
                trainingLogs = data;
            }
        }

        async function loadCustomEvents() {
            const { data, error } = await supabase
                .from('custom_training_events')
                .select('*')
                .eq('user_id', currentUser.id);

            if (!error && data) {
                customEvents = data;
            } else if (error && error.code === '42P01') {
                // Table doesn't exist yet - that's OK, user hasn't run the SQL yet
                console.log('Custom events table not found - run CUSTOM_EVENTS_TABLE.sql');
                customEvents = [];
            }
        }

        function getTrainingForDate(dateStr) {
            // Check if this date is deleted
            const deleted = customEvents.find(e => e.date === dateStr && e.action === 'delete');
            if (deleted) return null;

            // Check if there's a custom event for this date
            const custom = customEvents.find(e => e.date === dateStr && e.action === 'add');
            if (custom) {
                return {
                    type: custom.type,
                    name: custom.name,
                    description: custom.description,
                    duration: custom.duration,
                    intensity: custom.intensity,
                    route: custom.route,
                    workout: custom.workout,
                    intervals: custom.intervals
                };
            }

            // Return base plan
            return TRAINING_PLAN[dateStr] || null;
        }

        async function deleteTrainingDay(dateStr) {
            if (!confirm('Ali si prepriƒçan, da ≈æeli≈° izbrisati ta trening iz urnika?')) return;

            const { error } = await supabase
                .from('custom_training_events')
                .upsert({
                    user_id: currentUser.id,
                    date: dateStr,
                    action: 'delete'
                }, {
                    onConflict: 'user_id,date,action'
                });

            if (error) {
                if (error.code === '42P01') {
                    alert('Najprej po≈æeni SQL iz datoteke CUSTOM_EVENTS_TABLE.sql v Supabase!');
                } else {
                    alert('Napaka: ' + error.message);
                }
                return;
            }

            await loadCustomEvents();
            closeModal();
            renderCalendar();
        }

        function updateUserInfo() {
            if (userProfile) {
                document.getElementById('userName').textContent = userProfile.full_name || userProfile.email;
                document.getElementById('userLocation').textContent = userProfile.location || '-';
            }
        }

        // ========================================
        // CALENDAR FUNCTIONS
        // ========================================
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const monthNames = ['Januar', 'Februar', 'Marec', 'April', 'Maj', 'Junij',
                              'Julij', 'Avgust', 'September', 'Oktober', 'November', 'December'];
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            let startDay = firstDay.getDay();
            if (startDay === 0) startDay = 7;
            startDay--;

            const daysInMonth = lastDay.getDate();
            const prevDaysInMonth = prevLastDay.getDate();

            let html = '';

            const dayNames = ['PON', 'TOR', 'SRE', 'ƒåET', 'PET', 'SOB', 'NED'];
            dayNames.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevDaysInMonth - i;
                html += `<div class="calendar-day other-month"><div class="day-number">${day}</div></div>`;
            }

            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const training = getTrainingForDate(dateStr);
                const log = trainingLogs.find(l => l.date === dateStr);

                let classes = 'calendar-day';
                if (today.getDate() === day && today.getMonth() === month && today.getFullYear() === year) {
                    classes += ' today';
                }
                if (training) classes += ' has-training';
                if (log) classes += ' completed';

                html += `<div class="${classes}" onclick="openDay('${dateStr}')">`;
                html += `<div class="day-number">${day}</div>`;

                if (training) {
                    html += `<div class="day-training ${training.type}">${training.name}</div>`;
                    if (training.duration) {
                        html += `<div class="day-training ${training.type}">${training.duration}</div>`;
                    }
                }

                if (log) {
                    html += `<div class="day-training" style="background: rgba(40, 167, 69, 0.3);">‚úì Opravljeno</div>`;
                }

                html += '</div>';
            }

            const totalCells = Math.ceil((startDay + daysInMonth) / 7) * 7;
            const nextDays = totalCells - (startDay + daysInMonth);
            for (let i = 1; i <= nextDays; i++) {
                html += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
            }

            document.getElementById('calendarGrid').innerHTML = html;
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function today() {
            currentDate = new Date(2025, 10, 18);
            renderCalendar();
        }

        function openDay(dateStr) {
            const training = getTrainingForDate(dateStr);
            const log = trainingLogs.find(l => l.date === dateStr);

            const hasBaseTraining = TRAINING_PLAN[dateStr] !== undefined;

            if (!training && !log) {
                alert('Ni naƒçrtovanega treninga za ta dan.');
                return;
            }

            const date = new Date(dateStr);
            const dateFormatted = date.toLocaleDateString('sl-SI', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            document.getElementById('modalTitle').textContent = training.name;
            document.getElementById('modalDate').textContent = dateFormatted;

            let html = '<div class="training-info">';
            html += '<h3>üìã Podrobnosti Treninga</h3>';
            html += `<div class="info-row"><span class="info-label">Tip:</span><span class="info-value">${training.name}</span></div>`;
            html += `<div class="info-row"><span class="info-label">Opis:</span><span class="info-value">${training.description}</span></div>`;
            html += `<div class="info-row"><span class="info-label">Trajanje:</span><span class="info-value">${training.duration}</span></div>`;
            if (training.intensity) {
                html += `<div class="info-row"><span class="info-label">Intenzivnost:</span><span class="info-value"><span class="intensity-badge intensity-${training.intensity.toLowerCase().replace('-', '')}">${training.intensity}</span></span></div>`;
            }
            if (training.intervals) {
                html += `<div class="info-row"><span class="info-label">Intervali:</span><span class="info-value">${training.intervals}</span></div>`;
            }
            html += '</div>';

            // Route links based on user preference
            if (training.route && userProfile) {
                const route = ROUTES_DATA[training.route];
                const links = getRouteLink(training.route, userProfile.cycling_app);
                html += '<div class="training-info">';
                html += '<h3>üó∫Ô∏è Predlagana Pot</h3>';
                html += `<p><strong>${route.name}</strong></p>`;
                html += `<p>Razdalja: ${route.distance} | Vi≈°ina: ${route.elevation}</p>`;
                html += `<p>${route.description}</p>`;
                html += `<a href="${links.app}" class="route-link">üìç Odpri v ${userProfile.cycling_app.charAt(0).toUpperCase() + userProfile.cycling_app.slice(1)}</a>`;
                html += `<a href="${links.web}" target="_blank" class="route-link" style="background: #6c757d;">üåê Web verzija</a>`;
                html += `<button onclick="downloadGPX(${training.route})" class="route-link" style="background: #28a745; border: none; cursor: pointer;">üì• GPX</button>`;
                html += `<button onclick="quickKomootImport(${training.route})" class="route-link" style="background: #ff6900; border: none; cursor: pointer;">üöÄ Komoot Import</button>`;
                html += '</div>';
            }

            // Workout links based on user preference
            if (training.workout && userProfile) {
                const workout = WORKOUTS_DATA[training.workout];
                const links = getWorkoutLink(training.workout, userProfile.indoor_app);
                html += '<div class="training-info">';
                html += '<h3>üè† Predlagan Workout</h3>';
                html += `<p><strong>${workout.name}</strong></p>`;
                html += `<p>Trajanje: ${workout.duration} | Moƒç: ${workout.power}</p>`;
                html += `<p>${workout.description}</p>`;
                html += `<a href="${links.app}" class="workout-link">üîó Odpri v ${userProfile.indoor_app.charAt(0).toUpperCase() + userProfile.indoor_app.slice(1)}</a>`;
                html += `<a href="${links.web}" target="_blank" class="workout-link" style="background: #6c757d;">üåê Web verzija</a>`;
                html += '</div>';
            }

            // Training log form or display
            if (!log) {
                html += renderLogForm(dateStr, training);
            } else {
                html += '<div class="alert alert-success">‚úì Trening ≈æe zabele≈æen!</div>';
                html += '<div class="training-info">';
                html += '<h3>üìä Zabele≈æeni Podatki</h3>';
                html += `<div class="info-row"><span class="info-label">ƒåas:</span><span class="info-value">${log.duration} min</span></div>`;
                if (log.distance) html += `<div class="info-row"><span class="info-label">Razdalja:</span><span class="info-value">${log.distance} km</span></div>`;
                if (log.elevation) html += `<div class="info-row"><span class="info-label">Vi≈°ina:</span><span class="info-value">${log.elevation} m</span></div>`;
                if (log.avg_hr) html += `<div class="info-row"><span class="info-label">Avg HR:</span><span class="info-value">${log.avg_hr} BPM</span></div>`;
                if (log.avg_power) html += `<div class="info-row"><span class="info-label">Avg Power:</span><span class="info-value">${log.avg_power} W</span></div>`;
                if (log.notes) html += `<div class="info-row"><span class="info-label">Opombe:</span><span class="info-value">${log.notes}</span></div>`;
                html += `<button class="btn btn-secondary" style="margin-top: 15px;" onclick="deleteLog('${log.id}')">Izbri≈°i zapis</button>`;
                html += '</div>';
            }

            // Add delete training button if this is a base plan training
            if (hasBaseTraining && training) {
                html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">';
                html += `<button class="btn btn-danger" onclick="deleteTrainingDay('${dateStr}')">üóëÔ∏è Izbri≈°i ta trening iz urnika</button>`;
                html += '</div>';
            }

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('trainingModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('trainingModal').classList.remove('active');
        }

        function renderLogForm(dateStr, training) {
            return `
                <div class="log-form">
                    <h3>üìù Zabele≈æi Trening</h3>
                    <form onsubmit="saveLog(event, '${dateStr}')">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>ƒåas (min) *</label>
                                <input type="number" name="duration" required min="1">
                            </div>
                            ${training.type === 'bike' || training.type === 'trainer' ? `
                                <div class="form-group">
                                    <label>Razdalja (km)</label>
                                    <input type="number" name="distance" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label>Vi≈°inski metri (m)</label>
                                    <input type="number" name="elevation">
                                </div>
                                <div class="form-group">
                                    <label>Povpreƒçna hitrost (km/h)</label>
                                    <input type="number" name="avgSpeed" step="0.1">
                                </div>
                            ` : ''}
                            <div class="form-group">
                                <label>Povpreƒçen pulz (BPM)</label>
                                <input type="number" name="avgHr">
                            </div>
                            <div class="form-group">
                                <label>Maksimalen pulz (BPM)</label>
                                <input type="number" name="maxHr">
                            </div>
                            ${training.type === 'bike' || training.type === 'trainer' ? `
                                <div class="form-group">
                                    <label>Povpreƒçna moƒç (W)</label>
                                    <input type="number" name="avgPower">
                                </div>
                                <div class="form-group">
                                    <label>Maksimalna moƒç (W)</label>
                                    <input type="number" name="maxPower">
                                </div>
                            ` : ''}
                            <div class="form-group">
                                <label>Fiziƒçni obƒçutek (1-10)</label>
                                <input type="number" name="physicalFeeling" min="1" max="10">
                            </div>
                            <div class="form-group">
                                <label>Psihiƒçni obƒçutek (1-10)</label>
                                <input type="number" name="mentalFeeling" min="1" max="10">
                            </div>
                            <div class="form-group">
                                <label>Splo≈°no poƒçutje (1-10)</label>
                                <input type="number" name="generalFeeling" min="1" max="10">
                            </div>
                            <div class="form-group">
                                <label>Vreme</label>
                                <select name="weather">
                                    <option value="">Izberi...</option>
                                    <option value="sunny">Sonƒçno</option>
                                    <option value="cloudy">Oblaƒçno</option>
                                    <option value="rainy">De≈æuje</option>
                                    <option value="snowy">Sne≈æi</option>
                                    <option value="windy">Vetrovno</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Opombe</label>
                            <textarea name="notes" placeholder="Kako si se poƒçutil, kaj si se nauƒçil, te≈æave..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">üíæ Shrani Trening</button>
                    </form>
                </div>
            `;
        }

        async function saveLog(event, dateStr) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const log = {
                user_id: currentUser.id,
                date: dateStr,
                duration: parseInt(formData.get('duration')),
                distance: formData.get('distance') ? parseFloat(formData.get('distance')) : null,
                elevation: formData.get('elevation') ? parseInt(formData.get('elevation')) : null,
                avg_speed: formData.get('avgSpeed') ? parseFloat(formData.get('avgSpeed')) : null,
                avg_hr: formData.get('avgHr') ? parseInt(formData.get('avgHr')) : null,
                max_hr: formData.get('maxHr') ? parseInt(formData.get('maxHr')) : null,
                avg_power: formData.get('avgPower') ? parseInt(formData.get('avgPower')) : null,
                max_power: formData.get('maxPower') ? parseInt(formData.get('maxPower')) : null,
                physical_feeling: formData.get('physicalFeeling') ? parseInt(formData.get('physicalFeeling')) : null,
                mental_feeling: formData.get('mentalFeeling') ? parseInt(formData.get('mentalFeeling')) : null,
                general_feeling: formData.get('generalFeeling') ? parseInt(formData.get('generalFeeling')) : null,
                weather: formData.get('weather') || null,
                notes: formData.get('notes') || null
            };

            const { error } = await supabase
                .from('training_logs')
                .insert([log]);

            if (error) {
                alert('Napaka pri shranjevanju: ' + error.message);
                return;
            }

            alert('‚úì Trening uspe≈°no zabele≈æen!');
            await loadTrainingLogs();
            closeModal();
            renderCalendar();
            updateStats();
        }

        async function deleteLog(logId) {
            if (!confirm('Ali si prepriƒçan, da ≈æeli≈° izbrisati ta zapis?')) return;

            const { error } = await supabase
                .from('training_logs')
                .delete()
                .eq('id', logId);

            if (error) {
                alert('Napaka pri brisanju: ' + error.message);
                return;
            }

            alert('Zapis izbrisan.');
            await loadTrainingLogs();
            closeModal();
            renderCalendar();
            updateStats();
        }

        // ========================================
        // ROUTES & WORKOUTS RENDERING
        // ========================================
        function renderRoutes() {
            if (!userProfile) return;

            let html = '';
            for (let id in ROUTES_DATA) {
                const route = ROUTES_DATA[id];
                const links = getRouteLink(parseInt(id), userProfile.cycling_app);
                html += `
                    <div class="route-card">
                        <h3>${route.name}</h3>
                        <div class="route-details">
                            <div class="route-detail">
                                <span class="label">Razdalja</span>
                                <span class="value">${route.distance}</span>
                            </div>
                            <div class="route-detail">
                                <span class="label">Vi≈°ina</span>
                                <span class="value">${route.elevation}</span>
                            </div>
                            <div class="route-detail">
                                <span class="label">Intenzivnost</span>
                                <span class="value">${route.intensity}</span>
                            </div>
                        </div>
                        <p style="margin: 10px 0; color: #666;">${route.description}</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #999;"><strong>Tip:</strong> ${route.type}</p>
                        <a href="${links.app}" class="route-link">üìç ${userProfile.cycling_app.toUpperCase()}</a>
                        <a href="${links.web}" target="_blank" class="route-link" style="background: #6c757d;">üåê Web</a>
                        <button onclick="downloadGPX(${id})" class="route-link" style="background: #28a745; border: none; cursor: pointer;">üì• GPX</button>
                        <button onclick="quickKomootImport(${id})" class="route-link" style="background: #ff6900; border: none; cursor: pointer;">üöÄ Komoot Import</button>
                    </div>
                `;
            }
            document.getElementById('routesGrid').innerHTML = html;
        }

        function renderWorkouts() {
            if (!userProfile) return;

            let html = '';
            for (let id in WORKOUTS_DATA) {
                const workout = WORKOUTS_DATA[id];
                const links = getWorkoutLink(parseInt(id), userProfile.indoor_app);
                html += `
                    <div class="route-card">
                        <h3>${workout.name}</h3>
                        <div class="route-details">
                            <div class="route-detail">
                                <span class="label">Trajanje</span>
                                <span class="value">${workout.duration}</span>
                            </div>
                            <div class="route-detail">
                                <span class="label">Intenzivnost</span>
                                <span class="value">${workout.intensity}</span>
                            </div>
                            <div class="route-detail">
                                <span class="label">Moƒç</span>
                                <span class="value">${workout.power}</span>
                            </div>
                        </div>
                        <p style="margin: 10px 0; color: #666;">${workout.description}</p>
                        <a href="${links.app}" class="workout-link">üîó ${userProfile.indoor_app.toUpperCase()}</a>
                        <a href="${links.web}" target="_blank" class="workout-link" style="background: #6c757d;">üåê Web</a>
                    </div>
                `;
            }
            document.getElementById('workoutsGrid').innerHTML = html;
        }

        // ========================================
        // STATS & LOGS
        // ========================================
        function renderLog() {
            if (trainingLogs.length === 0) {
                document.getElementById('logContent').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <h3>≈†e ni zabele≈æenih treningov</h3>
                        <p>Ko bo≈° opravil trening in ga zabele≈æil v koledarju, se bo prikazal tukaj.</p>
                    </div>
                `;
                return;
            }

            let html = '<table class="log-table">';
            html += '<thead><tr>';
            html += '<th>Datum</th><th>ƒåas</th><th>Razdalja</th><th>Vi≈°ina</th><th>Avg HR</th><th>Avg Moƒç</th><th>Obƒçutek</th><th>Opombe</th><th>Akcije</th>';
            html += '</tr></thead><tbody>';

            trainingLogs.forEach(log => {
                const date = new Date(log.date);
                const formatted = date.toLocaleDateString('sl-SI');
                html += '<tr>';
                html += `<td>${formatted}</td>`;
                html += `<td>${log.duration} min</td>`;
                html += `<td>${log.distance || '-'} km</td>`;
                html += `<td>${log.elevation || '-'} m</td>`;
                html += `<td>${log.avg_hr || '-'} BPM</td>`;
                html += `<td>${log.avg_power || '-'} W</td>`;
                html += `<td>${log.physical_feeling || '-'} / ${log.general_feeling || '-'}</td>`;
                html += `<td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${log.notes || '-'}</td>`;
                html += `<td><button class="delete-btn" onclick="deleteLog('${log.id}')">Izbri≈°i</button></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('logContent').innerHTML = html;
        }

        function renderStats() {
            const totalTrainings = trainingLogs.length;
            const totalMinutes = trainingLogs.reduce((sum, log) => sum + (log.duration || 0), 0);
            const totalKm = trainingLogs.reduce((sum, log) => sum + (parseFloat(log.distance) || 0), 0);
            const totalElevation = trainingLogs.reduce((sum, log) => sum + (log.elevation || 0), 0);

            const feelingLogs = trainingLogs.filter(l => l.general_feeling);
            const avgFeeling = feelingLogs.length > 0
                ? feelingLogs.reduce((sum, log) => sum + log.general_feeling, 0) / feelingLogs.length
                : 0;

            const totalPlanned = Object.keys(TRAINING_PLAN).filter(d => new Date(d) <= new Date()).length;
            const completionRate = totalPlanned > 0 ? (totalTrainings / totalPlanned * 100) : 0;

            let html = `
                <div class="training-info">
                    <h3>üìä Skupna Statistika</h3>
                    <div class="info-row">
                        <span class="info-label">Opravljenih treningov:</span>
                        <span class="info-value">${totalTrainings} / ${totalPlanned} (${completionRate.toFixed(1)}%)</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${completionRate}%"></div>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Skupaj ur:</span>
                        <span class="info-value">${(totalMinutes / 60).toFixed(1)} h</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Skupaj kilometrov:</span>
                        <span class="info-value">${totalKm.toFixed(1)} km</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Skupaj vi≈°inskih metrov:</span>
                        <span class="info-value">${totalElevation} m</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Povpreƒçno poƒçutje:</span>
                        <span class="info-value">${avgFeeling.toFixed(1)} / 10</span>
                    </div>
                </div>
            `;

            document.getElementById('statsContent').innerHTML = html;
        }

        function updateStats() {
            const totalTrainings = trainingLogs.length;
            const totalMinutes = trainingLogs.reduce((sum, log) => sum + (log.duration || 0), 0);
            const totalKm = trainingLogs.reduce((sum, log) => sum + (parseFloat(log.distance) || 0), 0);

            document.getElementById('totalTrainings').textContent = totalTrainings;
            document.getElementById('totalHours').textContent = (totalMinutes / 60).toFixed(1) + 'h';
            document.getElementById('totalKm').textContent = totalKm.toFixed(1) + 'km';
        }

        // ========================================
        // PROFILE MANAGEMENT
        // ========================================
        function renderProfile() {
            if (!userProfile) return;

            let html = `
                <div class="training-info">
                    <h3>üë§ Osebni Podatki</h3>
                    <form onsubmit="updateProfile(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ime in priimek</label>
                                <input type="text" name="fullName" value="${userProfile.full_name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" value="${userProfile.email || ''}" disabled style="background: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Kraj bivanja</label>
                                <input type="text" name="location" value="${userProfile.location || ''}" placeholder="npr. Zavrtec, Rovte">
                            </div>
                        </div>

                        <h3 style="margin-top: 30px; margin-bottom: 15px;">üö¥ Nastavitve Aplikacij</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Priljubljena aplikacija za kolesarjenje</label>
                                <select name="cyclingApp">
                                    <option value="komoot" ${userProfile.cycling_app === 'komoot' ? 'selected' : ''}>Komoot</option>
                                    <option value="strava" ${userProfile.cycling_app === 'strava' ? 'selected' : ''}>Strava</option>
                                    <option value="ridewithgps" ${userProfile.cycling_app === 'ridewithgps' ? 'selected' : ''}>RideWithGPS</option>
                                    <option value="garmin" ${userProfile.cycling_app === 'garmin' ? 'selected' : ''}>Garmin Connect</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Priljubljena aplikacija za indoor trening</label>
                                <select name="indoorApp">
                                    <option value="mywhoosh" ${userProfile.indoor_app === 'mywhoosh' ? 'selected' : ''}>MyWhoosh</option>
                                    <option value="zwift" ${userProfile.indoor_app === 'zwift' ? 'selected' : ''}>Zwift</option>
                                    <option value="trainerroad" ${userProfile.indoor_app === 'trainerroad' ? 'selected' : ''}>TrainerRoad</option>
                                    <option value="rouvy" ${userProfile.indoor_app === 'rouvy' ? 'selected' : ''}>Rouvy</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <button type="submit" class="btn btn-primary">üíæ Shrani Spremembe</button>
                        </div>
                    </form>
                </div>

                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>‚ÑπÔ∏è Opomba o nastavitvah aplikacij:</strong><br>
                    Ko spremeni≈° priljubljeno aplikacijo, se bodo vsi linki v aplikaciji prilagodili.
                    Poti in workouts bodo odpirali izbrano aplikacijo namesto privzete.
                </div>
            `;

            document.getElementById('profileContent').innerHTML = html;
        }

        async function updateProfile(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const updates = {
                full_name: formData.get('fullName'),
                location: formData.get('location'),
                cycling_app: formData.get('cyclingApp'),
                indoor_app: formData.get('indoorApp')
            };

            const { error } = await supabase
                .from('profiles')
                .update(updates)
                .eq('id', currentUser.id);

            if (error) {
                alert('Napaka pri shranjevanju: ' + error.message);
                return;
            }

            userProfile = { ...userProfile, ...updates };
            alert('‚úÖ Profil uspe≈°no posodobljen!');
            updateUserInfo();
            renderRoutes();
            renderWorkouts();
        }

        // ========================================
        // VIEW MANAGEMENT
        // ========================================
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(viewName).classList.add('active');
            event.target.classList.add('active');
            currentView = viewName;

            if (viewName === 'log') renderLog();
            if (viewName === 'stats') renderStats();
            if (viewName === 'profile') renderProfile();
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('trainingModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ========================================
        // INITIALIZE APP
        // ========================================
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if Supabase credentials are configured
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                document.body.innerHTML = `
                    <div class="auth-container">
                        <h1>‚ö†Ô∏è Konfiguracija Potrebna</h1>
                        <div class="alert alert-error">
                            <strong>Supabase ni konfiguriran!</strong><br><br>
                            Prosim, sledi navodilom v datoteki <strong>SUPABASE_SETUP_GUIDE.md</strong>
                            za nastavitev Supabase projekta.<br><br>
                            Ko dobi≈° API kljuƒçe, jih vstavi v datoteko <strong>index-supabase.html</strong>.
                        </div>
                    </div>
                `;
                return;
            }

            await checkAuth();
        });
    </script>
</body>
</html>